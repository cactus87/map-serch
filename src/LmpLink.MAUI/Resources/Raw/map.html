<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naver Map</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=a5r744p216"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // Global variables
        let map = null;
        let markers = {};
        let currentCircle = null;
        
        // Auth failure handler
        window.navermap_authFailure = function() {
            alert('네이버 지도 인증 실패!\n\n콘솔에서 Web 서비스 URL 등록 확인:\n- file:///\n- http://localhost\n\n현재 URL: ' + window.location.href);
        };
        
        // Initialize map
        function initMap() {
            try {
                const dobongCenter = new naver.maps.LatLng(37.6688, 127.0471);
                
                const mapOptions = {
                    center: dobongCenter,
                    zoom: 14,
                    minZoom: 10,
                    maxZoom: 18,
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: naver.maps.MapTypeControlStyle.BUTTON,
                        position: naver.maps.Position.TOP_RIGHT
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        style: naver.maps.ZoomControlStyle.SMALL,
                        position: naver.maps.Position.TOP_LEFT
                    }
                };
                
                map = new naver.maps.Map('map', mapOptions);
                console.log('Map initialized successfully');
                return true;
            } catch (error) {
                console.error('Map initialization failed:', error);
                alert('지도 초기화 실패: ' + error.message);
                return false;
            }
        }
        
        // Add single marker (C# calls with individual parameters)
        function addMarker(id, type, lat, lng, name, address) {
            try {
                if (!map) {
                    console.error('Map not initialized');
                    return false;
                }
                
                const position = new naver.maps.LatLng(lat, lng);
                const isUser = type === 'user';
                
                const marker = new naver.maps.Marker({
                    position: position,
                    map: map,
                    title: name,
                    icon: {
                        content: isUser 
                            ? '<div style="width:16px;height:16px;border-radius:50%;background:#3B82F6;border:2px solid white;"></div>'
                            : '<div style="width:16px;height:16px;background:#F97316;border:2px solid white;"></div>',
                        anchor: new naver.maps.Point(8, 8)
                    }
                });
                
                // Info window on click
                const infoWindow = new naver.maps.InfoWindow({
                    content: `<div style="padding:10px;min-width:150px;">
                                <h4 style="margin:0 0 5px 0;">${name}</h4>
                                <p style="margin:0;font-size:12px;color:#666;">${address || '주소 정보 없음'}</p>
                              </div>`
                });
                
                naver.maps.Event.addListener(marker, 'click', function() {
                    if (infoWindow.getMap()) {
                        infoWindow.close();
                    } else {
                        infoWindow.open(map, marker);
                    }
                });
                
                markers[id] = marker;
                console.log(`✅ Marker added: ${name} (${type}) at [${lat}, ${lng}]`);
                return true;
            } catch (error) {
                console.error('❌ Add marker failed:', error);
                return false;
            }
        }
        
        // Add multiple markers
        function addMarkers(persons) {
            try {
                let count = 0;
                persons.forEach(person => {
                    if (addMarker(person)) count++;
                });
                console.log(`${count}/${persons.length} markers added`);
                return true;
            } catch (error) {
                console.error('Add markers failed:', error);
                return false;
            }
        }
        
        // Draw circle
        function drawCircle(lat, lng, radiusKm) {
            try {
                if (!map) return false;
                
                // Remove existing circle
                if (currentCircle) {
                    currentCircle.setMap(null);
                }
                
                const center = new naver.maps.LatLng(lat, lng);
                const radiusMeters = radiusKm * 1000;
                
                currentCircle = new naver.maps.Circle({
                    map: map,
                    center: center,
                    radius: radiusMeters,
                    fillColor: '#3B82F6',
                    fillOpacity: 0.2,
                    strokeColor: '#3B82F6',
                    strokeOpacity: 0.8,
                    strokeWeight: 2
                });
                
                console.log(`Circle drawn: ${radiusKm}km`);
                return true;
            } catch (error) {
                console.error('Draw circle failed:', error);
                return false;
            }
        }
        
        // Clear circle
        function clearCircle() {
            try {
                if (currentCircle) {
                    currentCircle.setMap(null);
                    currentCircle = null;
                    console.log('Circle cleared');
                }
                return true;
            } catch (error) {
                console.error('Clear circle failed:', error);
                return false;
            }
        }
        
        // Set marker visibility
        function setMarkerVisible(markerId, visible) {
            try {
                const marker = markers[markerId];
                if (marker) {
                    marker.setMap(visible ? map : null);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Set marker visibility failed:', error);
                return false;
            }
        }
        
        // Show all markers
        function showAllMarkers() {
            try {
                Object.values(markers).forEach(marker => {
                    marker.setMap(map);
                });
                console.log('All markers shown');
                return true;
            } catch (error) {
                console.error('Show all markers failed:', error);
                return false;
            }
        }
        
        // Set map center
        function setMapCenter(lat, lng) {
            try {
                if (!map) return false;
                const center = new naver.maps.LatLng(lat, lng);
                map.setCenter(center);
                console.log(`Map center set to: ${lat}, ${lng}`);
                return true;
            } catch (error) {
                console.error('Set map center failed:', error);
                return false;
            }
        }
        
        // Focus on marker with highlight
        function focusMarker(markerId) {
            try {
                const marker = markers[markerId];
                if (!marker) {
                    console.error(`Marker ${markerId} not found`);
                    return false;
                }
                
                // Move map center to marker
                map.setCenter(marker.getPosition());
                map.setZoom(15); // Zoom in
                
                // Trigger click event to open InfoWindow
                naver.maps.Event.trigger(marker, 'click');
                
                console.log(`✨ Focused on marker ${markerId}`);
                return true;
            } catch (error) {
                console.error('Focus marker failed:', error);
                return false;
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing map...');
            
            // Check if naver object is available
            if (typeof naver === 'undefined') {
                console.error('ERROR: Naver Maps API not loaded! Check API key.');
                return;
            }
            
            console.log('Naver Maps API loaded successfully! Initializing map...');
            const result = initMap();
            
            if (result) {
                console.log('Map initialized successfully!');
            } else {
                console.error('Map initialization failed!');
            }
        });
    </script>
</body>
</html>
