<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naver Map</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=a5r744p216"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // Global variables
        let map = null;
        let markers = {};
        let currentCircle = null;
        let highlightedMarker = null; // Currently highlighted marker
        let openInfoWindows = []; // Track all open info windows
        
        // Auth failure handler
        window.navermap_authFailure = function() {
            alert('네이버 지도 인증 실패!\n\n콘솔에서 Web 서비스 URL 등록 확인:\n- file:///\n- http://localhost\n\n현재 URL: ' + window.location.href);
        };
        
        // Initialize map
        function initMap() {
            try {
                const dobongCenter = new naver.maps.LatLng(37.6688, 127.0471);
                
                const mapOptions = {
                    center: dobongCenter,
                    zoom: 14,
                    minZoom: 10,
                    maxZoom: 18,
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: naver.maps.MapTypeControlStyle.BUTTON,
                        position: naver.maps.Position.TOP_RIGHT
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        style: naver.maps.ZoomControlStyle.SMALL,
                        position: naver.maps.Position.TOP_LEFT
                    }
                };
                
                map = new naver.maps.Map('map', mapOptions);
                
                // Close all info windows when clicking on empty map area
                naver.maps.Event.addListener(map, 'click', function() {
                    closeAllInfoWindows();
                });
                
                console.log('Map initialized successfully');
                return true;
            } catch (error) {
                console.error('Map initialization failed:', error);
                alert('지도 초기화 실패: ' + error.message);
                return false;
            }
        }
        
        // Add single marker (C# calls with individual parameters)
        function addMarker(id, type, lat, lng, name, address) {
            try {
                if (!map) {
                    console.error('Map not initialized');
                    return false;
                }
                
                const position = new naver.maps.LatLng(lat, lng);
                const isUser = type === 'user';
                
                const marker = new naver.maps.Marker({
                    position: position,
                    map: map,
                    title: name,
                    icon: {
                        content: isUser 
                            ? '<div class="marker-default" style="width:16px;height:16px;border-radius:50%;background:#3B82F6;border:2px solid white;transition:all 0.3s;"></div>'
                            : '<div class="marker-default" style="width:16px;height:16px;background:#F97316;border:2px solid white;transition:all 0.3s;"></div>',
                        anchor: new naver.maps.Point(8, 8)
                    }
                });
                
                // Store marker metadata
                marker._personId = id;
                marker._personType = type;
                marker._personName = name;
                marker._personAddress = address;
                
                // Info window with same transparency as radius overlay (#B0000000 = 69% opacity)
                const infoWindow = new naver.maps.InfoWindow({
                    content: `<div style="
                        padding: 12px 16px;
                        min-width: 160px;
                        background: rgba(0, 0, 0, 0.69);
                        border-radius: 8px;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                    ">
                        <h4 style="
                            margin: 0 0 6px 0;
                            color: white;
                            font-size: 15px;
                            font-weight: bold;
                        ">${name}</h4>
                        <p style="
                            margin: 0;
                            font-size: 13px;
                            color: #DDDDDD;
                            line-height: 1.4;
                        ">${address || '주소 정보 없음'}</p>
                    </div>`,
                    borderWidth: 0,
                    backgroundColor: 'transparent',
                    anchorSize: new naver.maps.Size(0, 0),
                    pixelOffset: new naver.maps.Point(0, -10)
                });
                
                // Store info window reference
                marker._infoWindow = infoWindow;
                
                naver.maps.Event.addListener(marker, 'click', function(e) {
                    // Prevent map click event
                    e.domEvent.stopPropagation();
                    
                    if (infoWindow.getMap()) {
                        infoWindow.close();
                        removeFromOpenInfoWindows(infoWindow);
                    } else {
                        closeAllInfoWindows(); // Close all others first
                        infoWindow.open(map, marker);
                        openInfoWindows.push(infoWindow);
                    }
                });
                
                markers[id] = marker;
                console.log(`✅ Marker added: ${name} (${type}) at [${lat}, ${lng}]`);
                return true;
            } catch (error) {
                console.error('❌ Add marker failed:', error);
                return false;
            }
        }
        
        // Add multiple markers
        function addMarkers(persons) {
            try {
                let count = 0;
                persons.forEach(person => {
                    if (addMarker(person)) count++;
                });
                console.log(`${count}/${persons.length} markers added`);
                return true;
            } catch (error) {
                console.error('Add markers failed:', error);
                return false;
            }
        }
        
        // Draw circle
        function drawCircle(lat, lng, radiusKm) {
            try {
                if (!map) return false;
                
                // Remove existing circle
                if (currentCircle) {
                    currentCircle.setMap(null);
                }
                
                const center = new naver.maps.LatLng(lat, lng);
                const radiusMeters = radiusKm * 1000;
                
                currentCircle = new naver.maps.Circle({
                    map: map,
                    center: center,
                    radius: radiusMeters,
                    fillColor: '#3B82F6',
                    fillOpacity: 0.2,
                    strokeColor: '#3B82F6',
                    strokeOpacity: 0.8,
                    strokeWeight: 2
                });
                
                console.log(`Circle drawn: ${radiusKm}km`);
                return true;
            } catch (error) {
                console.error('Draw circle failed:', error);
                return false;
            }
        }
        
        // Clear circle
        function clearCircle() {
            try {
                if (currentCircle) {
                    currentCircle.setMap(null);
                    currentCircle = null;
                    console.log('Circle cleared');
                }
                return true;
            } catch (error) {
                console.error('Clear circle failed:', error);
                return false;
            }
        }
        
        // Set marker visibility
        function setMarkerVisible(markerId, visible) {
            try {
                const marker = markers[markerId];
                if (marker) {
                    marker.setMap(visible ? map : null);
                    const action = visible ? '표시' : '숨김';
                    console.log(`Marker ${markerId} (${marker._personType}): ${action}`);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Set marker visibility failed:', error);
                return false;
            }
        }
        
        // Show all markers
        function showAllMarkers() {
            try {
                Object.values(markers).forEach(marker => {
                    marker.setMap(map);
                });
                console.log('All markers shown');
                return true;
            } catch (error) {
                console.error('Show all markers failed:', error);
                return false;
            }
        }
        
        // Set map center
        function setMapCenter(lat, lng) {
            try {
                if (!map) return false;
                const center = new naver.maps.LatLng(lat, lng);
                map.setCenter(center);
                console.log(`Map center set to: ${lat}, ${lng}`);
                return true;
            } catch (error) {
                console.error('Set map center failed:', error);
                return false;
            }
        }
        
        // Focus on marker with highlight (크기 확대, 색상 변경, 진동 애니메이션)
        function focusMarker(markerId) {
            try {
                const marker = markers[markerId];
                if (!marker) {
                    console.error(`Marker ${markerId} not found`);
                    return false;
                }
                
                // Reset previous highlighted marker
                if (highlightedMarker && highlightedMarker !== marker) {
                    const prevType = highlightedMarker._personType;
                    const prevIsUser = prevType === 'user';
                    highlightedMarker.setIcon({
                        content: prevIsUser 
                            ? '<div style="width:16px;height:16px;border-radius:50%;background:#3B82F6;border:2px solid white;transition:all 0.3s;"></div>'
                            : '<div style="width:16px;height:16px;background:#F97316;border:2px solid white;transition:all 0.3s;"></div>',
                        anchor: new naver.maps.Point(8, 8)
                    });
                }
                
                // Highlight current marker (크기 2배, 색상 밝게, 진동 애니메이션)
                const isUser = marker._personType === 'user';
                marker.setIcon({
                    content: isUser 
                        ? `<div style="width:32px;height:32px;border-radius:50%;background:#60A5FA;border:3px solid white;box-shadow:0 0 20px rgba(59,130,246,0.8);animation:bounce 0.6s ease-in-out;"></div>
                           <style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>`
                        : `<div style="width:32px;height:32px;background:#FB923C;border:3px solid white;box-shadow:0 0 20px rgba(249,115,22,0.8);animation:bounce 0.6s ease-in-out;"></div>
                           <style>@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }</style>`,
                    anchor: new naver.maps.Point(16, 16)
                });
                
                highlightedMarker = marker;
                
                // Move map center to marker
                map.setCenter(marker.getPosition());
                map.setZoom(15); // Zoom in
                
                // Open InfoWindow (close others first)
                const infoWindow = marker._infoWindow;
                if (infoWindow) {
                    closeAllInfoWindows();
                    infoWindow.open(map, marker);
                    openInfoWindows.push(infoWindow);
                }
                
                console.log(`✨ Focused on marker ${markerId} with highlight and InfoWindow`);
                return true;
            } catch (error) {
                console.error('Focus marker failed:', error);
                return false;
            }
        }
        
        // Close all info windows
        function closeAllInfoWindows() {
            openInfoWindows.forEach(infoWindow => {
                infoWindow.close();
            });
            openInfoWindows = [];
        }
        
        // Remove info window from tracking array
        function removeFromOpenInfoWindows(infoWindow) {
            const index = openInfoWindows.indexOf(infoWindow);
            if (index > -1) {
                openInfoWindows.splice(index, 1);
            }
        }
        
        // Get visible marker count (지도에 실제로 표시된 마커 개수)
        function getVisibleMarkerCount() {
            try {
                let userCount = 0;
                let assistantCount = 0;
                
                Object.values(markers).forEach(marker => {
                    if (marker.getMap()) { // 지도에 표시 중인 마커만
                        if (marker._personType === 'user') {
                            userCount++;
                        } else {
                            assistantCount++;
                        }
                    }
                });
                
                console.log(`Visible markers: 이용자 ${userCount}명, 지원사 ${assistantCount}명`);
                return JSON.stringify({ users: userCount, assistants: assistantCount });
            } catch (error) {
                console.error('Get visible marker count failed:', error);
                return JSON.stringify({ users: 0, assistants: 0 });
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing map...');
            
            // Check if naver object is available
            if (typeof naver === 'undefined') {
                console.error('ERROR: Naver Maps API not loaded! Check API key.');
                return;
            }
            
            console.log('Naver Maps API loaded successfully! Initializing map...');
            const result = initMap();
            
            if (result) {
                console.log('Map initialized successfully!');
            } else {
                console.error('Map initialization failed!');
            }
        });
    </script>
</body>
</html>
