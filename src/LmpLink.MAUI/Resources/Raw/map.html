<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LMP-Link Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Naver Maps API v3 -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=YOUR_CLIENT_ID"></script>
    
    <script>
        // Global variables
        let map = null;
        let markers = {};
        let circle = null;

        // Ensure Naver Maps API is loaded
        function ensureNaverMapsLoaded() {
            if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
                console.error('Naver Maps API not loaded. Check API key configuration.');
                throw new Error('Naver Maps API not loaded');
            }
        }

        // Initialize map
        window.initMap = function(lat, lng, zoom) {
            try {
                ensureNaverMapsLoaded();
                
                const mapOptions = {
                    center: new naver.maps.LatLng(lat, lng),
                    zoom: zoom,
                    zoomControl: true,
                    zoomControlOptions: {
                        position: naver.maps.Position.TOP_RIGHT
                    }
                };
                
                map = new naver.maps.Map('map', mapOptions);
                console.log('Map initialized:', lat, lng, zoom);
                return true;
            } catch (error) {
                console.error('Map initialization failed:', error);
                return false;
            }
        };

        // Add marker
        window.addMarker = function(id, lat, lng, type, name) {
            try {
                ensureNaverMapsLoaded();
                
                if (!map) {
                    console.error('Map not initialized');
                    return false;
                }

                const position = new naver.maps.LatLng(lat, lng);
                let markerOptions = {
                    position: position,
                    map: map,
                    title: name
                };

                // Marker style based on type
                if (type === 'User') {
                    // User: Blue circle (20x20px)
                    markerOptions.icon = {
                        content: '<div style="width:20px;height:20px;background-color:#4285F4;border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);cursor:pointer;"></div>',
                        anchor: new naver.maps.Point(10, 10)
                    };
                } else {
                    // Assistant: Orange square (16x16px)
                    markerOptions.icon = {
                        content: '<div style="width:16px;height:16px;background-color:#FF9800;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                        anchor: new naver.maps.Point(8, 8)
                    };
                }

                const marker = new naver.maps.Marker(markerOptions);
                markers[id] = marker;

                // Click event for User markers
                if (type === 'User') {
                    naver.maps.Event.addListener(marker, 'click', function() {
                        // Call C# via custom URL scheme
                        window.location.href = 'maui://markerclick?id=' + id + '&lat=' + lat + '&lng=' + lng;
                    });
                }

                console.log('Marker added:', id, type, name);
                return true;
            } catch (error) {
                console.error('Marker add failed:', error);
                return false;
            }
        };

        // Set marker visibility
        window.setMarkerVisible = function(id, visible) {
            if (markers[id]) {
                markers[id].setMap(visible ? map : null);
                return true;
            }
            return false;
        };

        // Show all markers
        window.showAllMarkers = function() {
            for (let id in markers) {
                markers[id].setMap(map);
            }
            return true;
        };

        // Draw circle
        window.drawCircle = function(lat, lng, radiusKm) {
            try {
                ensureNaverMapsLoaded();
                
                if (!map) {
                    console.error('Map not initialized');
                    return false;
                }
                
                clearCircle();

                circle = new naver.maps.Circle({
                    map: map,
                    center: new naver.maps.LatLng(lat, lng),
                    radius: radiusKm * 1000, // km to m
                    fillColor: '#4285F4',
                    fillOpacity: 0.2,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.6,
                    strokeWeight: 2
                });

                console.log('Circle drawn:', lat, lng, radiusKm + 'km');
                return true;
            } catch (error) {
                console.error('Circle draw failed:', error);
                return false;
            }
        };

        // Clear circle
        window.clearCircle = function() {
            if (circle) {
                circle.setMap(null);
                circle = null;
                console.log('Circle cleared');
            }
            return true;
        };

        // Clear all markers
        window.clearAllMarkers = function() {
            for (let id in markers) {
                markers[id].setMap(null);
            }
            markers = {};
            console.log('All markers cleared');
            return true;
        };

        // Get map center
        window.getMapCenter = function() {
            if (map) {
                const center = map.getCenter();
                return { lat: center.lat(), lng: center.lng() };
            }
            return null;
        };

        // Set map center
        window.setMapCenter = function(lat, lng) {
            if (map) {
                map.setCenter(new naver.maps.LatLng(lat, lng));
                return true;
            }
            return false;
        };

        // Log ready state
        console.log('Map HTML loaded and ready');
    </script>
</body>
</html>
