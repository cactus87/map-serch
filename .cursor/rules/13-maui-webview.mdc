---
description: MAUI WebView + Naver Maps JS Interop
globs:
  - "**/*WebView*"
  - "**/map.html"
  - "**/Services/**/MapService.cs"
alwaysApply: false
---

# MAUI WebView + JS Interop Rules

## WebView HTML 로드

### 외부 파일 사용 (권장)
```xml
<!-- MainPage.xaml -->
<WebView x:Name="MapWebView" Source="map.html" />
```

```
Resources/Raw/map.html (MauiAsset)
```

## JS → C# 통신 (Platform별)

```csharp
// Windows
window.chrome.webview.postMessage({ type: 'markerClick', id: 1 });

// iOS
window.webkit.messageHandlers.cordova_iab.postMessage(data);

// Android
AndroidBridge.postMessage(JSON.stringify(data));
```

## C# → JS 통신

```csharp
// MapService.cs
public async Task InitMapAsync()
{
    if (_webView == null) return;
    
    try
    {
        var result = await _webView.EvaluateJavaScriptAsync("initMap()");
        MauiProgram.Log($"initMap result: {result}");
    }
    catch (Exception ex)
    {
        MauiProgram.Log($"JS Interop failed: {ex.Message}");
    }
}
```

## 네이버 Maps API 설정

### API 스크립트 (2025년 기준)
```html
<!-- ✅ 올바름 -->
<script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=a5r744p216"></script>

<!-- ❌ 구버전 (작동 안 함) -->
<script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=..."></script>
```

### 인증 실패 처리
```javascript
window.navermap_authFailure = function() {
    alert('네이버 지도 인증 실패! 콘솔 Web 서비스 URL 확인');
};
```

### 필수 등록 URL (네이버 클라우드 콘솔)
```
file:///
http://localhost
http://localhost/
http://127.0.0.1
http://127.0.0.1/
```

## WebView Events

```csharp
// MainPage.xaml.cs
MapWebView.Navigated += OnWebViewNavigated;
MapWebView.Navigating += OnWebViewNavigating;

private async void OnWebViewNavigated(object? sender, WebNavigatedEventArgs e)
{
    if (e.Result != WebNavigationResult.Success) return;
    
    _mapService?.SetWebView(MapWebView);
    await Task.Delay(500);  // DOM ready 대기
    await _mapService.InitMapAsync();
}
```

---

**참고**: 
- 네이버_API_인증_가이드.md (인증 문제)
- MAUI_개발_가이드.md Section 6 (WebView + JS Interop)


